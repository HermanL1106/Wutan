<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é›»å‹•æ©Ÿè»Šå·¥å–®ç³»çµ±</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 1000px; margin: auto; }
    label { display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 15px; padding: 10px 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 30px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top; }
    .service-items-container { margin-top: 10px; }
    .service-item-row { display: flex; gap: 10px; margin-top: 5px; }
    .service-item-row input { flex: 1; }
    .remove-item { background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    .action-buttons { display: flex; justify-content: center; gap: 10px; }
    th { position: sticky; top: 0; background: #f9f9f9; z-index: 1; }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container">
    <h1>é›»å‹•æ©Ÿè»Šå·¥å–®ç³»çµ±</h1>

    <input type="file" id="importFile" accept=".csv">
    <button onclick="importWorkOrders()">åŒ¯å…¥ CSV å·¥å–®</button>
    <button onclick="exportWorkOrders()">åŒ¯å‡ºå·¥å–® CSV</button>

    <div style="margin-top: 20px;">
      <input type="text" id="searchPlate" placeholder="æœå°‹è»Šç‰Œæˆ–å·¥å–®ç·¨è™Ÿ">
      <label>èµ·å§‹æ—¥æœŸï¼š</label>
      <input type="date" id="startDate">
      <label>çµæŸæ—¥æœŸï¼š</label>
      <input type="date" id="endDate">
      <button onclick="searchOrders()">æœå°‹</button>
      <button onclick="resetSearch()">é‡è¨­</button>
    </div>

    <form id="workOrderForm">
      <input type="hidden" id="editIndex">
      <label>å·¥å–®ç·¨è™Ÿï¼š</label>
      <input type="text" id="workOrderNumber" readonly>
      <label>è»Šä¸»å§“åï¼š</label>
      <input type="text" id="ownerName" required>
      <label>è¯çµ¡é›»è©±ï¼š</label>
      <input type="text" id="phoneNumber" required>
      <label>è»Šç‰Œè™Ÿç¢¼ï¼š</label>
      <input type="text" id="plateNumber" required>
      <label>é‡Œç¨‹æ•¸ï¼š</label>
      <input type="number" id="mileage" required>
      <label>ç¶­ä¿®é …ç›®ï¼š</label>
      <div id="serviceItems" class="service-items-container"></div>
      <button type="button" onclick="addServiceItem()">æ–°å¢é …ç›®</button>
      <label>æŠ€å¸«å§“åï¼š</label>
      <select id="technicianName" required>
        <option value="Kevin">Kevin</option>
        <option value="Hank">Hank</option>
      </select>
      <label>ç‹€æ…‹ï¼š</label>
      <select id="status">
        <option value="å¾…è™•ç†">å¾…è™•ç†</option>
        <option value="è™•ç†ä¸­">è™•ç†ä¸­</option>
        <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
      </select>
      <label>æ—¥æœŸï¼š</label>
      <input type="date" id="orderDate" required>
      <div style="margin-top: 15px;">
        <button type="submit">å„²å­˜å·¥å–®</button>
        <button type="button" onclick="resetForm()">é‡è¨­</button>
	<button type="button" onclick="deleteSelectedOrders()">åˆªé™¤æ‰€é¸å·¥å–®</button>      
	</div>
    </form>

    <table id="workOrderTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
          <th>å·¥å–®ç·¨è™Ÿ</th>
          <th>è»Šä¸»</th>
          <th>é›»è©±</th>
          <th>è»Šç‰Œ</th>
          <th>é‡Œç¨‹æ•¸</th>
          <th>ç¶­ä¿®é …ç›®</th>
          <th>ç¸½é‡‘é¡</th>
          <th>æŠ€å¸«</th>
          <th>ç‹€æ…‹</th>
          <th>æ—¥æœŸ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const firebaseConfig = {
  apiKey: "AIzaSyCJRG7xReo0_dx-ZaJhaUVIEU58JifmVAk",
  authDomain: "electric-bike-workorders.firebaseapp.com",
  projectId: "electric-bike-workorders",
  storageBucket: "electric-bike-workorders.firebasestorage.app",
  messagingSenderId: "41212869744",
  appId: "1:41212869744:web:be69af07e77e816efb88b5",
  measurementId: "G-V3VTZZ0T59"
};

firebase.initializeApp(firebaseConfig);
firebase.analytics();
const db = firebase.firestore();

let workOrders = JSON.parse(localStorage.getItem('workOrders') || '[]');
let currentPage = 1;
const pageSize = 30;

// è¡¨å–®æäº¤
document.getElementById('workOrderForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const index = document.getElementById('editIndex').value;
  const serviceItems = Array.from(document.querySelectorAll('.service-item-row')).map(row => {
    return {
      name: row.querySelector('.item-name').value.trim(),
      cost: parseFloat(row.querySelector('.item-cost').value)
    };
  });
  const totalAmount = serviceItems.reduce((sum, item) => sum + (item.cost || 0), 0);
  const newOrder = {
    workOrderNumber: document.getElementById('orderDate').value.replace(/-/g, '') + '-' + (index !== '' ? workOrders[index].workOrderNumber.split('-')[1] : (workOrders.length + 1).toString().padStart(3, '0')),
    ownerName: document.getElementById('ownerName').value.trim(),
    phoneNumber: document.getElementById('phoneNumber').value.trim(),
    plateNumber: document.getElementById('plateNumber').value.trim(),
    mileage: document.getElementById('mileage').value.trim(),
    serviceItems: serviceItems,
    technicianName: document.getElementById('technicianName').value,
    status: document.getElementById('status').value,
    date: document.getElementById('orderDate').value,
    totalAmount: totalAmount
  };
  if (index === '') {
    workOrders.push(newOrder);
  } else {
    workOrders[index] = newOrder;
  }
  saveToLocalStorage();
  displayWorkOrders(workOrders);

  db.collection("workOrders").doc(newOrder.workOrderNumber).set(newOrder)
  .then(() => alert("å·¥å–®å·²åŒæ­¥åˆ° Firebaseï¼"))
  .catch((error) => console.error("Firebase å„²å­˜éŒ¯èª¤:", error));

  this.reset();
  document.getElementById('serviceItems').innerHTML = '';
  document.getElementById('editIndex').value = '';
});

function resetForm() {
  document.getElementById('workOrderForm').reset();
  document.getElementById('serviceItems').innerHTML = '';
  document.getElementById('editIndex').value = '';
}

function addServiceItem(item = { name: '', cost: '' }) {
  const container = document.getElementById('serviceItems');
  const div = document.createElement('div');
  div.className = 'service-item-row';
  div.innerHTML = `
    <input type="text" class="item-name" placeholder="é …ç›®åç¨±" value="${item.name}">
    <input type="number" class="item-cost" placeholder="é‡‘é¡" value="${item.cost}">
    <button type="button" class="remove-item" onclick="this.parentElement.remove()">åˆªé™¤</button>
  `;
  container.appendChild(div);
}

function deleteWorkOrder(index) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å·¥å–®å—ï¼Ÿ')) return;
  const deletedOrder = workOrders.splice(index, 1)[0];
  saveToLocalStorage();
  displayWorkOrders(workOrders);
  db.collection("workOrders").doc(deletedOrder.workOrderNumber).delete()
  .then(() => alert('å·¥å–®å·²åˆªé™¤ (å« Firebase)'))
  .catch((error) => console.error("Firebase åˆªé™¤éŒ¯èª¤:", error));
}

function deleteSelectedOrders() {
  const selected = Array.from(document.querySelectorAll('.select-order:checked'));
  if (selected.length === 0) {
    alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„å·¥å–®');
    return;
  }
  if (!confirm(`ç¢ºå®šè¦åˆªé™¤å·²é¸å–çš„ ${selected.length} ç­†å·¥å–®å—ï¼Ÿ`)) return;
  const indexes = selected.map(checkbox => parseInt(checkbox.getAttribute('data-index'))).sort((a, b) => b - a);
  indexes.forEach(idx => {
    const deletedOrder = workOrders.splice(idx, 1)[0];
    db.collection("workOrders").doc(deletedOrder.workOrderNumber).delete()
    .then(() => console.log(`Firebase åˆªé™¤ ${deletedOrder.workOrderNumber} æˆåŠŸ`))
    .catch((error) => console.error(`Firebase åˆªé™¤ ${deletedOrder.workOrderNumber} éŒ¯èª¤:`, error));
  });
  saveToLocalStorage();
  displayWorkOrders(workOrders);
  alert('å·²åˆªé™¤æ‰€é¸å·¥å–® (å« Firebase)');
}

function editWorkOrder(index) {
  const order = workOrders[index];
  document.getElementById('editIndex').value = index;
  document.getElementById('workOrderNumber').value = order.workOrderNumber;
  document.getElementById('ownerName').value = order.ownerName;
  document.getElementById('phoneNumber').value = order.phoneNumber;
  document.getElementById('plateNumber').value = order.plateNumber;
  document.getElementById('mileage').value = order.mileage;
  document.getElementById('technicianName').value = order.technicianName;
  document.getElementById('status').value = order.status;
  document.getElementById('orderDate').value = order.date;
  document.getElementById('serviceItems').innerHTML = '';
  order.serviceItems.forEach(item => addServiceItem(item));
}

function saveToLocalStorage() {
  localStorage.setItem('workOrders', JSON.stringify(workOrders));
}

function toggleSelectAll(source) {
  const checkboxes = document.querySelectorAll('.select-order');
  checkboxes.forEach(box => box.checked = source.checked);
}

function resetSearch() {
  document.getElementById('searchPlate').value = '';
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  displayWorkOrders(workOrders);
}

function searchOrders() {
  const plate = document.getElementById('searchPlate').value.trim();
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  const results = workOrders.filter(order => {
    const matchPlate = plate ? (order.plateNumber.includes(plate) || order.workOrderNumber.includes(plate)) : true;
    let matchDate = true;
    if (start && end) {
      matchDate = order.date >= start && order.date <= end;
    } else if (start) {
      matchDate = order.date >= start;
    } else if (end) {
      matchDate = order.date <= end;
    }
    return matchPlate && matchDate;
  });
  if (results.length === 0) {
    alert('æŸ¥ç„¡ç›¸é—œå·¥å–®');
  }
  displayWorkOrders(results);
}

function importWorkOrders() {
  const file = document.getElementById('importFile').files[0];
  if (!file) {
    alert('è«‹é¸æ“‡ CSV æª”æ¡ˆ');
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    const content = e.target.result.replace(/\r/g, '').trim();
    const lines = content.split('\n').slice(1);
    lines.forEach(line => {
      const parts = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
      if (parts && parts.length >= 10) {
        const [workOrderNumber, ownerName, phoneNumber, plateNumber, mileage, serviceItemsStr, totalAmount, technicianName, status, date] = parts.map(item => item.replace(/^"|"$/g, '').trim());
        const serviceItems = serviceItemsStr.split(';').map(s => ({ name: s.trim(), cost: null }));
        const newOrder = {
          workOrderNumber,
          ownerName,
          phoneNumber,
          plateNumber,
          mileage,
          serviceItems,
          technicianName,
          status,
          date,
          totalAmount: parseFloat(totalAmount)
        };
        workOrders.push(newOrder);
        db.collection("workOrders").doc(newOrder.workOrderNumber).set(newOrder)
        .then(() => console.log(`Firebase åŒ¯å…¥ ${newOrder.workOrderNumber} æˆåŠŸ`))
        .catch((error) => console.error(`Firebase åŒ¯å…¥ ${newOrder.workOrderNumber} éŒ¯èª¤:`, error));
      }
    });
    saveToLocalStorage();
    displayWorkOrders(workOrders);
    alert('åŒ¯å…¥å®Œæˆ (å« Firebase)');
  };
  reader.readAsText(file);
}

function exportWorkOrders() {
  const rows = document.querySelectorAll('#workOrderTable tbody tr');
  if (rows.length === 0) {
    alert('ç›®å‰æ²’æœ‰å¯åŒ¯å‡ºçš„å·¥å–®');
    return;
  }
  let csvContent = 'å·¥å–®ç·¨è™Ÿ,è»Šä¸»,é›»è©±,è»Šç‰Œ,é‡Œç¨‹æ•¸,ç¶­ä¿®é …ç›®,ç¸½é‡‘é¡,æŠ€å¸«,ç‹€æ…‹,æ—¥æœŸ\n';
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const workOrderNumber = cells[1].innerText;
    const ownerName = cells[2].innerText;
    const phoneNumber = cells[3].innerText;
    const plateNumber = cells[4].innerText;
    const mileage = cells[5].innerText;
    const serviceItems = cells[6].innerText.replace(/\n/g, '; ').replace(/\$/g, '');
    const totalAmount = cells[7].innerText;
    const technicianName = cells[8].innerText;
    const status = cells[9].innerText;
    const date = cells[10].innerText;
    csvContent += `${workOrderNumber},${ownerName},${phoneNumber},${plateNumber},${mileage},"${serviceItems}",${totalAmount},${technicianName},${status},${date}\n`;
  });
  const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'work_orders.csv';
  link.click();
}

// åˆ†é åŠŸèƒ½ â” æˆ‘å¯ä»¥å†è£œè²¼ä¸€æ¬¡ï¼Œå¦‚æœ‰éœ€è¦å‘Šè¨´æˆ‘ ğŸ˜„
db.collection("workOrders").get().then((querySnapshot) => {
  workOrders = [];
  querySnapshot.forEach((doc) => {
    workOrders.push(doc.data());
  });
  saveToLocalStorage();
  displayWorkOrders(workOrders);
}).catch((error) => {
  console.error("è®€å– Firebase ç™¼ç”ŸéŒ¯èª¤: ", error);
  displayWorkOrders(workOrders);
});
	function displayWorkOrders(orders) {
  // æ—¥æœŸæ–°åˆ°èˆŠæ’åº
  orders.sort((a, b) => b.date.localeCompare(a.date));
  const tbody = document.querySelector('#workOrderTable tbody');
  tbody.innerHTML = '';

  const totalPages = Math.ceil(orders.length / pageSize);
  const start = (currentPage - 1) * pageSize;
  const pageData = orders.slice(start, start + pageSize);

  pageData.forEach((order, index) => {
    const globalIndex = start + index;
    const items = order.serviceItems.map((item, i) => `${i + 1}. ${item.name}`).join('<br>');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input type="checkbox" class="select-order" data-index="${globalIndex}"></td>
      <td>${order.workOrderNumber}</td>
      <td>${order.ownerName}</td>
      <td>${order.phoneNumber}</td>
      <td>${order.plateNumber}</td>
      <td>${order.mileage}</td>
      <td>${items}</td>
      <td>${order.totalAmount || 0}</td>
      <td>${order.technicianName}</td>
      <td>${order.status}</td>
      <td>${order.date}</td>
      <td>
        <div class="action-buttons">
          <button onclick="editWorkOrder(${globalIndex})">ç·¨è¼¯</button>
          <button onclick="deleteWorkOrder(${globalIndex})">åˆªé™¤</button>
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });

  renderPagination(totalPages);
}

function renderPagination(totalPages) {
  let pagination = document.getElementById('pagination');
  if (!pagination) {
    pagination = document.createElement('div');
    pagination.id = 'pagination';
    pagination.style.marginTop = '20px';
    pagination.style.textAlign = 'center';
    document.querySelector('.container').appendChild(pagination);
  }
  pagination.innerHTML = '';

  // ä¸Šä¸€é æŒ‰éˆ•
  const prevBtn = document.createElement('button');
  prevBtn.textContent = 'ä¸Šä¸€é ';
  prevBtn.style.margin = '0 5px';
  prevBtn.disabled = currentPage === 1;
  prevBtn.onclick = function() {
    if (currentPage > 1) {
      currentPage--;
      displayWorkOrders(workOrders);
    }
  };
  pagination.appendChild(prevBtn);

  // é ç¢¼æŒ‰éˆ•
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.style.margin = '0 5px';
    if (i === currentPage) {
      btn.disabled = true;
    }
    btn.onclick = function() {
      currentPage = i;
      displayWorkOrders(workOrders);
    };
    pagination.appendChild(btn);
  }

  // ä¸‹ä¸€é æŒ‰éˆ•
  const nextBtn = document.createElement('button');
  nextBtn.textContent = 'ä¸‹ä¸€é ';
  nextBtn.style.margin = '0 5px';
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.onclick = function() {
    if (currentPage < totalPages) {
      currentPage++;
      displayWorkOrders(workOrders);
    }
  };
  pagination.appendChild(nextBtn);

  // é¡¯ç¤ºç›®å‰é æ•¸/ç¸½é æ•¸
  const pageInfo = document.createElement('div');
  pageInfo.style.marginTop = '10px';
  pageInfo.textContent = `ç¬¬ ${currentPage} / ${totalPages} é `;
  pagination.appendChild(pageInfo);
}

  </script>
</body>
</html>
